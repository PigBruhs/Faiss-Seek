# 软件架构文档

**版本**: 2.0

## 修订历史记录

| 日期       | 版本 | 说明                      | 作者   |
| ---------- | ---- | ------------------------- | ------ |
| 24/05/2025 | 1.0  | 软件架构文档1.0（开发版） | 戴晓明 |
| 31/05/2025 | 2.0  | 软件架构文档2.0（迭代版） | 戴晓明 |

---

## 简介

### 目的

本文档从架构方面对系统进行综合概述，使用多种不同的架构视图描述系统的各个方面，记录并表述已对系统架构作出的重要决策。定义基于Faiss的图搜图引擎系统架构，通过多视图描述核心组件设计、技术选型及交互关系，指导实现高性能、可扩展的视觉搜索服务。

### 范围

覆盖系统核心功能模块与附加模块：

- 用户认证服务：注册登录
- 图片特征提取与索引管理：上传图片
- 相似性搜索引擎：搜索相似图片
- 内容审核与系统管理：管理图片库
- 图源提交与索引构建：管理图源

### 定义、首字母缩写词和缩略语

- **Faiss**: Facebook AI研究院开发的高效相似性搜索和聚类库，支持大规模数据的高维空间搜索。

### 参考资料

- Faiss官方文档
- IEEE 1471-2000架构描述标准

---

## 架构表示方式

采用4+1视图模型：

- **逻辑视图**: 子系统与类设计
- **进程视图**: 服务间通信流程
- **部署视图**: Kubernetes集群配置
- **实现视图**: 代码组织结构
- **用例视图**: 核心场景驱动设计

---

## 架构目标和约束

### 目标

答而多图图是一款基于Faiss的图搜图引擎，通过图片索引相似图片及分类，支持用户上传图片并通过图像特征匹配快速检索。

### 安全需求

- 对用户上传的图片进行病毒扫描。
- 保证用户上传的图片不被其他用户窃取。

### 性能需求

- 支持并发上传（同时上传100张照片）。
- 万张图库响应时间小于10秒。

### 精度需求

用户可自行修改前10张显示照片的精度要求。

### 自动化监测图片库

定时检测异常图片（如违规图片、单色图片、模糊图片）。

### 图源标签自动化

调用NLP模型分析网站描述文本，推荐预置分类标签。

---

## 用例视图

核心系统用例包括：

- 注册登录
- 上传图片
- 搜索相似图片
- 管理图片库
- 管理图源（附加功能）

---

## 逻辑视图

### 概述

软件分为模块：

- **用户视图**: 认证中心（注册登录验证用户身份）。
- **搜索服务**: 使用Faiss引擎提取图像特征，通过向量相似度对比展示前10张相似图片。
- **管理服务**: 管理图片库，确保无违规或异常图片。

### 关键设计包

| 类名             | 职责                  | 关联技术              |
| ---------------- | --------------------- | --------------------- |
| FeatureExtractor | 图像特征向量生成      | PyTorch, ONNX Runtime |
| IndexManager     | Faiss索引生命周期管理 | Faiss C++ API         |
| Router           | 结果聚合              | gRPC负载均衡          |

---

## 进程视图

![进程视图](media/image2.png)

---

## 部署视图

| 节点类型 | 数量 | 配置                     | 部署服务                 |
| -------- | ---- | ------------------------ | ------------------------ |
| GPU节点  | 4    | NVIDIA V100×2, 64GB内存 | Faiss索引服务, 特征提取  |
| API节点  | 8    | 16核CPU, 32GB内存        | Spring Boot微服务        |
| 存储节点 | 3    | Ceph集群                 | 图片对象存储, 特征数据库 |

---

## 实施视图

### 概述

分为三部分：

1. 前端注册登录
2. 后端引擎调用
3. 文档存储

### 分层设计

![分层设计](media/image4.png)

---

## 数据视图（可选）

![数据视图](media/image5.png)

---

## 大小和性能

- 每小时处理50万张图片
- 全量索引重建≤4小时

---

## 质量

| 属性     | 保障措施                                                                               |
| -------- | -------------------------------------------------------------------------------------- |
| 安全性   | 使用Token验证登录状态；通过 `Authorization: Bearer ${token}`传输；退出清除数据防泄露 |
| 可靠性   | 接口请求有状态码反馈；错误状态统一处理；Token失效自动跳转登录页                        |
| 可维护性 | 后端统一封装响应结构和错误码；前端集中处理错误；易于调试和扩展                         |
| 用户体验 | 登录状态自动保持；操作反馈及时明确；退出登录后界面重置清晰                             |
